<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Product - Extensions Lake</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <link rel="icon" href="https://iili.io/JpY272t.png" type="image/png">  
  <style>
    body {
      background-color: #f4f6f8;
      color: #333;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .container {
      background-color: #ffffff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      margin-top: 50px;
      text-align: left;
      width: 80%;
      max-width: 600px; 
    }

    h1 {
      color: #2962ff; 
      margin-bottom: 20px;
      text-align: center;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
    }

    input[type="text"],
    input[type="number"],
    input[type="url"],
    select,
    textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      font-family: inherit;
      box-sizing: border-box; 
    }

    button {
      background-color: #2962ff; 
      color: #ffffff;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
      transition: background-color 0.3s ease;
      display: block; 
      margin: 20px auto 0; 
      font-weight: 500;
    }

    button:hover {
      background-color: #0056c8; 
    }

    .success-message {
      background-color: #c8e6c9; 
      border-color: #81c784; 
      color: #2e7d32;
      padding: 10px 15px; 
      border: 1px solid transparent; 
      border-radius: 4px; 
      margin-top: 20px;
      display: none;
      text-align: center; 
    }

    .user-card {
      background-color: #ffffff; 
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px; 
      text-align: center; 
    }

    .user-card img {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid #e0e0e0; 
    }

    .user-card h3 {
      margin-top: 10px;
      color: #2962ff;
    }

    .auth-buttons {
      display: flex;
      justify-content: center; 
      align-items: center;
      margin-top: 10px; 
    }

    .auth-buttons button {
      margin: 0 5px;
      padding: 10px 20px;
      background-color: #FF9843; 
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      font-weight: 500; 
    }

    .auth-buttons button:hover {
      background-color: darken(#FF9843, 10%); 
    }

    #logoutBtn {
      background-color: #f44336; 
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      font-weight: 500; 
    }

    #logoutBtn:hover {
      background-color: darken(#f44336, 10%); 
    }

    .google-signin-btn {
      display: inline-flex;
      align-items: center; 
      background-color: #4285F4; 
      color: white;
      border: none;
      padding: 12px 24px; 
      border-radius: 8px; 
      cursor: pointer;
      transition: background-color 0.3s ease;
      text-decoration: none;
      font-weight: 500;
    }

    .google-signin-btn:hover {
      background-color: #357ae8;
    }

    .icon-container {
      display: flex;
      align-items: center; 
      margin-right: 10px; 
    }

    .google-logo {
      width: 20px; 
      height: 20px;
    }

    .btn-text {
      font-weight: bold;
    }

    #coverImagePreview {
      max-width: 100%; 
      max-height: 200px; 
      display: none;
      margin-bottom: 10px;
      border-radius: 8px; 
    }

    .file-upload-button {
      background-color: #2962ff; 
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
      margin-bottom: 10px;
      display: none; 
      font-weight: 500; 
    }

    .file-upload-button:hover {
      background-color: #0056c8; 
    }

    .cover-image-options label {
      display: flex;
      align-items: center; 
      margin-bottom: 5px; 
    }

    .cover-image-options input[type="radio"] {
      margin-right: 8px;
    }

    #publisherImagePreview {
      width: 80px; 
      height: 80px; 
      border-radius: 50%; 
      object-fit: cover; 
    }

    .material-symbols-outlined {
      font-variation-settings:
      'FILL' 0,
      'wght' 400,
      'GRAD' 0,
      'opsz' 48
    }

    .form-group .material-symbols-outlined {
      font-size: 1.2rem;
      vertical-align: middle;
      margin-right: 5px;
    }

    .back-button {
      display: inline-block;
      margin-bottom: 20px;
      padding: 8px 16px;
      background-color: #6c757d; /* Secondary color */
      color: white;
      border-radius: 8px;
      text-decoration: none;
      transition: background-color 0.3s ease;
      font-weight: 500;
    }
    .back-button:hover {
      background-color: #5a6268;
    }
    .back-button .material-symbols-outlined {
       vertical-align: middle;
       margin-right: 5px;
       font-size: 1.1em; /* Adjust icon size */
    }


    footer {
      background-color: #333;
      color: #fff;
      padding: 20px;
      text-align: center;
      margin-top: 50px; 
      width: 100%; 
      position: relative;
      bottom: 0;
    }

    footer p {
      margin: 5px 0; 
    }

    footer img { 
      margin: 0 5px; 
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <div class="container" id="authContainer"></div>
  <div class="container" id="productFormContainer" style="display: none;"> 
    <h1><span class="material-symbols-outlined">
        add_circle
        </span> Add new file</h1>
    <a href="index.html" class="back-button"><span class="material-symbols-outlined">arrow_back</span> Back to Home</a>
    <div id="userCard"></div>
    <form id="addProductForm">
      <div class="form-group">
        <label for="productName"><span class="material-symbols-outlined">
          extension
          </span> Product Name:</label>
        <input type="text" id="productName" name="productName" required>
      </div>
      <div class="form-group">
        <label for="productDescription"><span class="material-symbols-outlined">
          description
          </span> Description:</label>
        <textarea id="productDescription" name="productDescription" rows="4" required></textarea>
      </div>
      <div class="form-group">
        <label for="fileType"><span class="material-symbols-outlined">
          file_present
          </span> File Type:</label>
        <select id="fileType" name="fileType" required>
          <option value="AIX">AIX</option>
          <option value="AIA">AIA</option>
          <option value="APK">APK</option>
          <option value="text">Text</option>
          <option value="OpenSource">Open Source</option>
        </select>
      </div>
      <div class="form-group">
        <label for="productType"><span class="material-symbols-outlined">
          category
          </span> Type:</label>
        <select id="productType" name="productType" required>
          <option value="paid">Paid</option>
          <option value="free" selected>Free</option>
        </select>
      </div>
      <div class="form-group" id="paymentUrlGroup">
        <label for="paymentUrl"><span class="material-symbols-outlined">
          download
          </span> Free URL:</label> 
        <input type="url" id="paymentUrl" name="paymentUrl">
      </div>
      <div class="form-group cover-image-options">
        <label><span class="material-symbols-outlined">
          image
          </span> Choose Cover Image Source:</label>
        <input type="radio" id="coverImageURLRadio" name="coverImageSource" value="url" checked>
        <label for="coverImageURLRadio">From URL:</label>
        <input type="url" id="coverImageURL" name="coverImageURL" oninput="previewImageFromURL()"> 
        <br>
        <input type="radio" id="coverImageUploadRadio" name="coverImageSource" value="upload">
        <label for="coverImageUploadRadio">Upload Image:</label>
        <input type="file" id="coverImageUpload" accept="image/*" style="display: none;" onchange="previewImageFromFile()">
        <button type="button" class="file-upload-button" onclick="triggerFileUpload()">Choose File</button>
        <img id="coverImagePreview" src="" alt="Cover Image Preview">
      </div>
      <div class="form-group">
        <label for="topicURL"><span class="material-symbols-outlined">
          forum
          </span> Official Topic URL:</label>
        <input type="url" id="topicURL" name="topicURL" required>
      </div>
      <div class="form-group" id="priceGroup">
        <label for="productPrice"><span class="material-symbols-outlined">
          attach_money
          </span> Price:</label>
        <input type="number" id="productPrice" name="productPrice" min="0" step="0.01" value="0" readonly> 
      </div>
      <div class="form-group">
        <label for="publisherImageURL"><span class="material-symbols-outlined">
          account_circle
          </span> Publisher Image:</label>
        <img id="publisherImagePreview" src="" alt="Publisher Image"> 
        <input type="hidden" id="publisherImageURL" name="publisherImageURL">
      </div>
      <div class="form-group">
        <label for="publisherName"><span class="material-symbols-outlined">
          person
          </span> Publisher Name:</label>
        <label id="publisherNameLabel"></label> 
        <input type="hidden" id="publisherName" name="publisherName">
      </div>
      <div class="form-group">
        <label for="isVerified"><span class="material-symbols-outlined">
          verified
          </span> Is Verified?</label>
        <input type="checkbox" id="isVerified" name="isVerified">
      </div>
      <button type="submit">Add Product</button>
      <div class="success-message" id="successMessage">
        Product added successfully!
      </div>
    </form>
  </div>
  <footer>
    <p>About Us - We are a company dedicated to providing high-quality extensions.</p>
    <p>for 
      <img src="https://iili.io/dfBx14V.png" alt="Google Chrome Logo" height="30">
      <img src="https://iili.io/dfBxlCx.png" alt="Mozilla Firefox Logo" height="30">
      <img src="https://iili.io/dfBx0EQ.md.png" alt="Opera Browser Logo" height="30">
    </p>
    <p>© 2023 Extensions Lake. All rights reserved.</p>
  </footer>
    <script type="module">
    // --- Check Login Status ---
    document.addEventListener('DOMContentLoaded', () => {
        if (localStorage.getItem('isLoggedIn') !== 'true') {
            console.log('User not logged in, redirecting to index.html');
            window.location.href = 'index.html';
        } else {
            // User is logged in, proceed with initializing the page
            initApp(); // Call initApp only if logged in
        }
    });
    // --- End Check Login Status ---

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut } from 'https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCgy_AToJkB7iIkAf8A9yKYLGRcn6q3DGc",
      authDomain: "mypro-f9c43.firebaseapp.com",
      databaseURL: "https://mypro-f9c43-default-rtdb.firebaseio.com",
      projectId: "mypro-f9c43",
      storageBucket: "mypro-f9c43.appspot.com",
      messagingSenderId: "457342163754",
      appId: "1:457342163754:web:9f428caeea9ad5c5d11c53",
      measurementId: "G-YS7GD676WC"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);

    // --- Consolidated DOMContentLoaded Listener ---
    document.addEventListener('DOMContentLoaded', () => {
      // --- Login Check ---
      if (localStorage.getItem('isLoggedIn') !== 'true') {
          console.log('User not logged in, redirecting to index.html');
          window.location.href = 'index.html';
          return; // Stop further execution if not logged in
      }

      // --- Form Initialization (only if logged in) ---
      console.log('User logged in, initializing add product form...');
      const databaseURL = "https://mypro-f9c43-default-rtdb.firebaseio.com/";
      const apiKey = "AIzaSyBfDYW18AJSfb03Cm_lR-SCZpTbcnLH1Qk";
      const addProductForm = document.getElementById('addProductForm');
      const successMessage = document.getElementById('successMessage');
      const userCard = document.getElementById('userCard');
      const authContainer = document.getElementById('authContainer');
      const productFormContainer = document.getElementById('productFormContainer');
      const publisherNameLabel = document.getElementById('publisherNameLabel');
      const publisherImageURLInput = document.getElementById('publisherImageURL');
      const imgbbApiKey = '591f55a2f11247ad2c9dc9faf9df0836'; 
      const coverImageUpload = document.getElementById('coverImageUpload');
      const coverImagePreview = document.getElementById('coverImagePreview');
      const coverImageURLRadio = document.getElementById('coverImageURLRadio');
      const coverImageUploadRadio = document.getElementById('coverImageUploadRadio');
      const coverImageURLInput = document.getElementById('coverImageURL');
      const fileUploadButton = document.querySelector('.file-upload-button');
      const publisherImagePreview = document.getElementById('publisherImagePreview');
      const productTypeSelect = document.getElementById('productType');
      const paymentUrlGroup = document.getElementById('paymentUrlGroup');
      const priceGroup = document.getElementById('priceGroup');
      const productPriceInput = document.getElementById('productPrice');
      let currentUser = null;
      let existingProductNames = []; 

      function initApp() {
        auth.onAuthStateChanged(user => {
          currentUser = user;
          updateAuthDisplay(); 
        });
        fetchExistingProductNames(); 
      }

      function updateAuthDisplay() {
        if (currentUser) {
          userCard.innerHTML = `
            <div class="user-card">
              <img src="${currentUser.photoURL || 'https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y'}" alt="User Profile Picture">
              <h3>${currentUser.displayName || currentUser.email.split('@')[0]}</h3>
              <p>${currentUser.email}</p>
              <button id="logoutBtn">Logout</button>
            </div>
          `;
          publisherNameLabel.textContent = currentUser.displayName || currentUser.email.split('@')[0];
          publisherImagePreview.src = currentUser.photoURL || 'https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y'; 
          publisherImageURLInput.value = publisherImagePreview.src; 
          const logoutBtn = document.getElementById('logoutBtn');
          logoutBtn.addEventListener('click', () => {
            auth.signOut().then(() => {
              currentUser = null;
              updateAuthDisplay();
            }).catch(error => {
              console.error("Error signing out:", error);
            });
          });
        } else {
          authContainer.innerHTML = `
            <h2>Please sign in to add a product</h2>
            <button id="googleSignInButton" class="google-signin-btn" onclick="signInWithGoogle()">
              <span class="icon-container">
                <img src="https://iili.io/dKDr0W7.png" alt="Google Logo" class="google-logo">
              </span>
              <span class="btn-text">Sign In with Google</span>
            </button>
          `;
          userCard.innerHTML = '';
          publisherNameLabel.textContent = '';
          publisherImageURLInput.value = '';
        }
        toggleFormDisplay(); 
      }

      function toggleFormDisplay() {
        if (currentUser) {
          productFormContainer.style.display = 'block';
          authContainer.style.display = 'none';
        } else {
          productFormContainer.style.display = 'none';
          authContainer.style.display = 'block'; 
        }
      }

      addProductForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!currentUser) {
          alert("Please sign in to add a product.");
          return;
        }

        const productName = addProductForm.productName.value;

        if (existingProductNames.includes(productName)) {
          alert("A product with this name already exists. Please choose a different name.");
          return;
        }

        let coverImageURL = addProductForm.coverImageURL.value;
        if (coverImageUpload.files.length > 0) {
          coverImageURL = await uploadImageToImgBB(coverImageUpload.files[0]);
        }
        if (!coverImageURL) {
          alert("Please provide a cover image URL or upload an image.");
          return;
        }

        const productType = addProductForm.productType.value;
        const price = productType === 'paid' ? parseFloat(productPriceInput.value) : 0; 

        const newProduct = {
          name: productName, 
          description: addProductForm.productDescription.value,
          fileType: addProductForm.fileType.value, 
          type: productType, 
          paymentUrl: addProductForm.paymentUrl.value, 
          coverImageURL: coverImageURL,
          topicURL: addProductForm.topicURL.value,
          publisherImageURL: addProductForm.publisherImageURL.value,
          publisherName: currentUser.displayName || currentUser.email.split('@')[0],
          publisherId: currentUser.uid,
          isVerified: addProductForm.isVerified.checked,
          date: new Date().toISOString().slice(0, 10),
          price: price
        };

        const productURL = `${databaseURL}/${encodeURIComponent(productName)}.json?auth=${apiKey}`;
        fetch(productURL, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(newProduct)
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          console.log('Product added successfully!', response);
          addProductForm.reset();
          productPriceInput.value = 0; 
          productPriceInput.readOnly = true; 
          successMessage.style.display = 'block';
          setTimeout(() => {
            successMessage.style.display = 'none';
          }, 3000);
          existingProductNames.push(productName);
        })
        .catch(error => {
          console.error('There has been a problem adding the product:', error);
        });
      });

      async function uploadImageToImgBB(imageFile) {
        const formData = new FormData();
        formData.append('image', imageFile);
        try {
          const response = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`, {
            method: 'POST',
            body: formData
          });
          if (!response.ok) {
            throw new Error('Image upload failed');
          }
          const data = await response.json();
          return data.data.url; 
        } catch (error) {
          console.error('Error uploading image:', error);
          alert('Error uploading image. Please try again.');
          return null;
        }
      }

      window.signInWithGoogle = () => {
        const provider = new GoogleAuthProvider();
        signInWithPopup(auth, provider)
          .then((result) => {
            currentUser = result.user;
            updateAuthDisplay();
          }).catch((error) => {
            console.error("Error signing in with Google:", error);
          });
      };

      window.previewImageFromURL = () => {
        const url = document.getElementById('coverImageURL').value;
        if (url) {
          coverImagePreview.src = url;
          coverImagePreview.style.display = 'block';
        } else {
          coverImagePreview.src = '';
          coverImagePreview.style.display = 'none';
        }
      };

      window.previewImageFromFile = () => {
        const fileInput = document.getElementById('coverImageUpload');
        if (fileInput.files && fileInput.files[0]) {
          const reader = new FileReader();
          reader.onload = (e) => {
            coverImagePreview.src = e.target.result;
            coverImagePreview.style.display = 'block';
          };
          reader.readAsDataURL(fileInput.files[0]);
        } else {
          coverImagePreview.src = '';
          coverImagePreview.style.display = 'none';
        }
      };

      window.triggerFileUpload = () => {
        coverImageUpload.click();
      };

      coverImageURLRadio.addEventListener('change', () => {
        coverImageURLInput.style.display = 'block';
        fileUploadButton.style.display = 'none'; 
        coverImagePreview.src = ''; 
        coverImagePreview.style.display = 'none';
      });

      coverImageUploadRadio.addEventListener('change', () => {
        coverImageURLInput.style.display = 'none';
        fileUploadButton.style.display = 'block'; 
        coverImagePreview.src = '';
        coverImagePreview.style.display = 'none';
      });

      productTypeSelect.addEventListener('change', () => {
        if (productTypeSelect.value === 'paid') {
          paymentUrlGroup.querySelector('label').innerHTML = '<span class="material-symbols-outlined">credit_card</span> Payment URL:';
          priceGroup.style.display = 'block';
          productPriceInput.readOnly = false; 
        } else {
          paymentUrlGroup.querySelector('label').innerHTML = '<span class="material-symbols-outlined">download</span> Free URL:'; 
          priceGroup.style.display = 'block';
          productPriceInput.value = 0; 
          productPriceInput.readOnly = true; 
        }
      });

      async function fetchExistingProductNames() {
        try {
          const response = await fetch(`${databaseURL}/.json?auth=${apiKey}`);
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          const data = await response.json();
          existingProductNames = Object.keys(data || {}); 
        } catch (error) {
          console.error("Error fetching existing product names:", error);
        }
      }

      // Call initApp here, now that all functions/variables are defined
      initApp();
    });
    // --- End Consolidated Listener ---

  </script>
</body>
</html>
